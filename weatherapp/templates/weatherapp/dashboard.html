{% extends 'weatherapp/base.html' %}

{% block content %}
<div class="dashboard">
    <h2>Weather Data Viewer</h2>

    <!-- Filter Section -->
    <div class="filter-section">
        <h3>Filter Data</h3>

        <div class="filter-group">
            <label for="region-select">Region:</label>
            <select id="region-select">
                <option value="">All Regions</option>
                <option value="UK">UK</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="parameter-select">Parameter:</label>
            <select id="parameter-select">
                <option value="">All Parameters</option>
                <option value="Tmax">Maximum Temperature (Tmax)</option>
                <option value="Tmin">Minimum Temperature (Tmin)</option>
                <option value="Tmean">Mean Temperature (Tmean)</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="start-date">Start Date:</label>
            <input type="date" id="start-date" value="2020-01-01">
        </div>

        <div class="filter-group">
            <label for="end-date">End Date:</label>
            <input type="date" id="end-date">
        </div>

        <button class="btn-primary" onclick="fetchAndDisplayData()">Fetch Data</button>
        <button class="btn-secondary" onclick="clearFilters()">Clear Filters</button>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-container">
            <h3>Temperature Trend</h3>
            <canvas id="temperatureChart"></canvas>
        </div>
    </div>

    <!-- Data Table Section -->
    <div class="table-section">
        <h3>Weather Data Table</h3>
        <table id="weather-table" class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Region</th>
                    <th>Parameter</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr>
                    <td colspan="4" style="text-align: center; color: #999;">Click "Fetch Data" to load weather
                        information</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // Set today's date as default end date
    document.getElementById('end-date').valueAsDate = new Date();

    let weatherChart = null;

    function fetchAndDisplayData() {
        const region = document.getElementById('region-select').value;
        const parameter = document.getElementById('parameter-select').value;
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        // Build API URL with filters
        let apiUrl = '/api/weather/?ordering=-date';
        if (region) apiUrl += `&region=${region}`;
        if (parameter) apiUrl += `&parameter=${parameter}`;
        if (startDate) apiUrl += `&start_date=${startDate}`;
        if (endDate) apiUrl += `&end_date=${endDate}`;

        // Fetch data from API
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Handle both paginated and non-paginated responses
                let results = data.results || data;

                // If it's an array, use it directly
                if (Array.isArray(results)) {
                    displayTable(results);
                    displayChart(results);
                } else {
                    alert('Unexpected data format received');
                    console.error('Data format:', data);
                }
            })
            .catch(error => {
                alert('Error fetching data: ' + error.message);
                console.error('Error:', error);
            });
    }


    function displayTable(data) {
        const tableBody = document.getElementById('table-body');

        if (!data || data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No data found for selected filters</td></tr>';
            return;
        }

        tableBody.innerHTML = data.slice(0, 100).map(item => `
            <tr>
                <td>${item.date}</td>
                <td>${item.region}</td>
                <td>${item.parameter}</td>
                <td><strong>${item.value}°C</strong></td>
            </tr>
        `).join('');
    }

    function displayChart(data) {
        if (!data || data.length === 0) {
            alert('No data to display in chart');
            return;
        }

        // Sort data by date
        data.sort((a, b) => new Date(a.date) - new Date(b.date));

        const labels = data.map(item => item.date);
        const values = data.map(item => item.value);

        const ctx = document.getElementById('temperatureChart').getContext('2d');

        // Destroy existing chart if it exists
        if (weatherChart) {
            weatherChart.destroy();
        }

        weatherChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Temperature (°C)',
                    data: values,
                    borderColor: '#FF6B6B',
                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointBackgroundColor: '#FF6B6B'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Temperature (°C)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                }
            }
        });
    }

    function clearFilters() {
        document.getElementById('region-select').value = '';
        document.getElementById('parameter-select').value = '';
        document.getElementById('start-date').value = '2020-01-01';
        document.getElementById('end-date').valueAsDate = new Date();
        document.getElementById('table-body').innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Click "Fetch Data" to load weather information</td></tr>';
    }

    // Auto-load data on page load
    window.addEventListener('load', function () {
        fetchAndDisplayData();
    });
</script>
{% endblock %}